import { useRef, useState, useEffect } from "react";
import { gsap } from "gsap";
import { Link, useNavigate, useLocation } from "react-router-dom";

interface NavLink {
  label: string;
  href: string;
  scrollTo?: string;
}

const navLinks: NavLink[] = [
  { label: "Home", href: "/" },
  { label: "About", href: "/about", scrollTo: "why-work-with-us" },
  { label: "Services", href: "/services", scrollTo: "what-we-do" },
  { label: "Work", href: "/work" },
];

export default function Navbar() {
  const [menuOpen, setMenuOpen] = useState(false);
  const [scrolled, setScrolled] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const topBar = useRef<HTMLDivElement>(null);
  const midBar = useRef<HTMLDivElement>(null);
  const botBar = useRef<HTMLDivElement>(null);
  const headerRef = useRef<HTMLElement>(null);
  const navigate = useNavigate();
  const location = useLocation();

  const handleMenuToggle = () => {
    setMenuOpen((prev) => {
      const next = !prev;
      if (next) {
        // Animate hamburger to X
        gsap.to(topBar.current, {
          y: 8,
          rotate: 45,
          duration: 0.3,
        });
        gsap.to(midBar.current, {
          opacity: 0,
          duration: 0.2,
        });
        gsap.to(botBar.current, {
          y: -8,
          rotate: -45,
          duration: 0.3,
        });
        // Animate menu in
        gsap.to(menuRef.current, {
          x: 0,
          opacity: 1,
          pointerEvents: "auto",
          duration: 0.4,
          ease: "power2.out",
        });
      } else {
        // Animate hamburger to lines
        gsap.to(topBar.current, {
          y: 0,
          rotate: 0,
          duration: 0.3,
        });
        gsap.to(midBar.current, {
          opacity: 1,
          duration: 0.2,
        });
        gsap.to(botBar.current, {
          y: 0,
          rotate: 0,
          duration: 0.3,
        });
        // Animate menu out
        gsap.to(menuRef.current, {
          x: "100%",
          opacity: 0,
          pointerEvents: "none",
          duration: 0.4,
          ease: "power2.in",
        });
      }
      return next;
    });
  };

  const scrollToSection = (sectionId: string) => {
    // If we're not on the homepage, navigate there first
    if (location.pathname !== "/") {
      navigate("/");
      // Store the section ID to scroll to after navigation
      sessionStorage.setItem("scrollToSection", sectionId);
      // Close mobile menu if open
      if (menuOpen) {
        setMenuOpen(false);
      }
      return;
    }

    // If we're on the homepage, scroll to the section
    const element = document.getElementById(sectionId);
    if (element) {
      element.scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    }
    // Close mobile menu if open
    if (menuOpen) {
      setMenuOpen(false);
    }
  };

  // Ensure menu is hidden on mount
  useEffect(() => {
    gsap.set(menuRef.current, { x: "100%", opacity: 0, pointerEvents: "none" });
  }, []);

  // Add scroll listener for navbar background and blur
  useEffect(() => {
    const handleScroll = () => {
      if (window.scrollY > 10) {
        setScrolled(true);
      } else {
        setScrolled(false);
      }
    };
    window.addEventListener("scroll", handleScroll, { passive: true });
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  // Handle scroll to section after navigation
  useEffect(() => {
    if (location.pathname === "/") {
      const sectionId = sessionStorage.getItem("scrollToSection");
      if (sectionId) {
        // Small delay to ensure the page has loaded
        setTimeout(() => {
          const element = document.getElementById(sectionId);
          if (element) {
            element.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
          // Clear the stored section ID
          sessionStorage.removeItem("scrollToSection");
        }, 100);
      }
    }
  }, [location.pathname]);

  return (
    <div>
      <header
        ref={headerRef}
        className={`fixed top-0 left-0 right-0 flex items-center justify-between px-6 md:px-20 z-[999999] transition-all duration-300 ${
          scrolled
            ? "bg-[#101010]/10 backdrop-blur-md shadow-lg py-3 md:py-4"
            : "bg-transparent py-4 md:py-6"
        }`}
        style={{
          WebkitBackdropFilter: scrolled ? "blur(16px)" : undefined,
          backdropFilter: scrolled ? "blur(16px)" : undefined,
        }}
      >
        {/* Logo */}

        <Link to="/" className="text-white text-xl font-light flex-shrink-0">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="110"
            viewBox="0 0 460 131"
            fill="none"
          >
            <g clipPath="url(#clip0_1170_38)">
              <path
                d="M295.583 129.693C293.155 130.386 290.524 130.735 287.706 130.735C281.933 130.735 277.031 129.339 273.133 126.593C270.44 124.691 268.257 122.352 266.611 119.601C264.068 122.743 261.015 125.306 257.498 127.244C253.33 129.563 248.449 130.74 242.999 130.74C240.045 130.74 237.32 130.391 234.871 129.698H199.516L198.448 123.238C196.213 125.004 193.462 126.791 190.3 128.12C186.148 129.86 181.094 130.74 175.28 130.74C169.1 130.74 163.573 129.709 158.852 127.672C154.023 125.598 149.933 122.691 146.703 119.039C146.494 118.804 146.286 118.564 146.083 118.32C141.185 123.498 131.703 130.74 116.949 130.74C110.764 130.74 105.231 129.709 100.506 127.672C99.3179 127.166 98.1092 126.567 96.8328 125.853C92.4408 123.363 88.9761 120.638 86.5066 117.741C86.3868 117.913 86.2669 118.085 86.1471 118.252C83.4431 122.003 80.0306 125.03 75.998 127.25C71.8457 129.563 66.9691 130.745 61.5143 130.745C58.555 130.745 55.825 130.396 53.3711 129.703H20.2929L0 114.209V41.9621L35.0059 4.29388L54.0328 30.8492V38.8882C57.2942 39.4821 60.3108 40.5397 63.0408 42.0454C67.3234 44.4108 70.9652 47.641 73.8724 51.6422C74.2266 52.132 74.5653 52.6321 74.8987 53.1375C75.4302 52.4029 75.9668 51.71 76.4982 51.0848C79.9264 47.1304 84.2194 43.994 89.2835 41.7224C94.3685 39.4613 100.271 38.3151 106.852 38.3151C114.172 38.3151 120.783 39.9354 126.504 43.1343C131.062 45.682 134.866 49.1258 137.861 53.4032C138.45 52.6009 139.065 51.8246 139.716 51.0691C143.134 47.1252 147.437 43.9835 152.507 41.7172C157.571 39.4561 163.474 38.3099 170.054 38.3099C177.374 38.3099 183.985 39.9302 189.706 43.1291C192.243 44.5514 194.551 46.2499 196.614 48.2141V41.9517L235.632 0.000854492V39.3571C238.164 38.6694 240.998 38.3203 244.083 38.3203C249.918 38.3203 255.149 39.5759 259.624 42.0506C263.901 44.416 267.548 47.641 270.456 51.6474C271.977 53.7575 273.285 56.0134 274.379 58.4048L292.025 39.4144L450.075 39.43V66.2198L435.164 82.2613H442.463C446.48 82.2613 450.44 83.4909 453.618 85.9448C454.175 86.372 454.707 86.8409 455.191 87.341C458.343 90.6181 460.01 94.7653 460.01 99.3396C460.01 102.888 459.02 106.128 457.077 108.978C456.207 110.249 455.066 111.437 453.592 112.62L432.272 129.683L295.594 129.698L295.583 129.693Z"
                fill="white"
              />
              <path
                d="M434.083 122.518C432.026 124.3 429.488 125.212 426.534 125.212H426.394L426.42 125.238H358.685L358.669 125.248H299.411V123.128C299.296 123.206 299.192 123.274 299.072 123.347C295.946 125.301 292.122 126.29 287.709 126.29C282.879 126.29 278.831 125.17 275.695 122.956C272.595 120.768 270.328 117.866 268.963 114.313C268.354 112.724 267.895 111.072 267.583 109.368C266.635 111.609 265.436 113.719 264.04 115.657C261.695 118.887 258.778 121.461 255.355 123.352C251.838 125.306 247.675 126.296 243.002 126.296C239.84 126.296 237.026 125.842 234.656 124.957C233.353 124.477 232.171 123.941 231.113 123.357V123.982H231.102V125.259H203.281L201.432 114.104C201.432 114.104 196.42 120.742 188.584 124.024C184.978 125.535 180.498 126.301 175.277 126.301C169.708 126.301 164.774 125.389 160.606 123.592C156.36 121.768 152.807 119.241 150.019 116.095C148.628 114.532 147.3 112.734 146.268 110.952C146.268 110.952 137.14 126.301 116.936 126.301C111.361 126.301 106.417 125.389 102.249 123.592C101.119 123.112 100.035 122.565 98.9929 121.977C96.1691 120.377 92.3033 117.824 89.6305 114.568C88.302 112.953 87.0412 111.103 86.0773 109.296C85.1135 111.562 83.9308 113.698 82.5241 115.662C80.2057 118.877 77.2933 121.456 73.8391 123.357C70.338 125.311 66.1856 126.301 61.4966 126.301C58.3185 126.301 55.5103 125.848 53.1242 124.962C51.8217 124.467 50.639 123.936 49.5814 123.347V125.259H21.7861L4.43164 112.02V43.707L34.561 11.2905L49.597 32.2763V42.8213H49.6126C53.8327 43.0818 57.6204 44.1238 60.8975 45.9317C64.5966 47.974 67.759 50.7718 70.2859 54.252C72.0416 56.6851 73.4744 59.3526 74.5841 62.2077C75.8605 59.6444 78.0071 56.1693 79.8827 53.9655C82.8523 50.5425 86.6244 47.7812 91.105 45.7754C95.6116 43.7695 100.905 42.7536 106.86 42.7536C113.409 42.7536 119.291 44.1863 124.345 47.0102C129.487 49.8861 133.535 54.0801 136.385 59.4829C136.89 60.4206 137.333 61.3949 137.75 62.4109C139.089 59.3787 140.876 56.5392 143.09 53.9603C146.06 50.5373 149.832 47.776 154.323 45.7702C158.814 43.7643 164.112 42.7484 170.062 42.7484C176.611 42.7484 182.493 44.1811 187.547 47.0049C192.689 49.8808 196.737 54.0749 199.587 59.4776C200.134 60.504 200.614 61.5721 201.056 62.6818V43.7018L231.196 11.2853V45.9317C232.327 45.3221 233.603 44.7334 235.052 44.202C237.615 43.2381 240.663 42.7588 244.086 42.7588C249.15 42.7588 253.667 43.8268 257.481 45.9369C261.18 47.9792 264.342 50.777 266.869 54.2572C269.292 57.6177 271.115 61.4158 272.298 65.5421C272.412 65.9589 272.532 66.3757 272.636 66.8029L293.961 43.8529L332.598 43.8789H408.836L408.846 43.8685H445.639V64.4792L424.976 86.6998H442.643L442.633 86.7102H442.92C446.567 86.7102 449.609 87.945 451.995 90.4197C454.376 92.8945 455.575 95.8902 455.575 99.3392C455.575 101.981 454.851 104.372 453.413 106.477C452.709 107.508 451.797 108.373 450.823 109.155L434.094 122.529L434.083 122.518Z"
                fill="#1A1A1A"
              />
              <path
                d="M448.793 93.4986C447.251 91.9043 445.333 91.1384 442.911 91.1384C440.488 91.1384 438.581 91.9043 437.039 93.4986C435.487 95.1189 434.721 97.0257 434.721 99.3285C434.721 101.631 435.487 103.476 437.055 105.132C438.597 106.753 440.514 107.529 442.911 107.529C445.307 107.529 447.24 106.753 448.782 105.132C450.366 103.476 451.127 101.569 451.127 99.3285C451.127 97.0882 450.361 95.1293 448.793 93.4986Z"
                fill="#FF7F00"
              />
              <path
                d="M401.781 48.3069H337.031V64.7496H363.43L337.031 93.1596V107.581H367.452L382.738 91.1382H362.31L401.781 48.3069Z"
                fill="white"
              />
              <path
                d="M441.19 48.2969H410.764L395.483 64.7396H415.912L389.523 93.1444L376.295 107.571H433.266C431.276 105.2 430.27 102.439 430.27 99.3287C430.27 96.2183 431.245 93.4466 433.172 91.1282H414.792L441.19 62.7233V48.2969Z"
                fill="white"
              />
              <path
                d="M309.629 48.2969V83.6414C309.629 85.7358 309.108 87.5854 308.056 89.1848C307.014 90.7843 305.232 91.5814 302.689 91.5814C300.147 91.5814 298.443 90.826 297.323 89.289C296.203 87.7677 295.645 85.8765 295.645 83.6414V48.5417L274.623 71.1687V88.8983C274.623 92.3369 275.196 95.5514 276.353 98.5732C277.509 101.595 279.411 104.039 282.058 105.904C284.699 107.764 288.19 108.701 292.509 108.701C296.469 108.701 299.787 107.868 302.47 106.19C305.154 104.513 307.316 102.179 308.952 99.1984H309.629V107.581H330.875V48.3073L309.629 48.2969Z"
                fill="white"
              />
              <path
                d="M268.021 66.761C266.979 63.114 265.39 59.8057 263.27 56.8621C261.134 53.9236 258.492 51.5635 255.33 49.8234C252.152 48.0624 248.406 47.1923 244.081 47.1923C241.179 47.1923 238.678 47.5831 236.594 48.3646C234.5 49.1461 232.807 50.0161 231.504 50.9904C230.191 51.9543 228.915 53.2307 227.639 54.7937H226.753V22.5856L205.496 45.447V107.586H226.753V101.1H227.639C228.915 102.663 230.191 103.924 231.504 104.903C232.807 105.867 234.5 106.753 236.594 107.534C238.678 108.311 241.179 108.701 244.081 108.701C248.406 108.701 252.152 107.831 255.33 106.076C258.492 104.33 261.134 101.975 263.27 99.0317C265.39 96.0881 266.979 92.7797 268.021 89.1223C269.063 85.4805 269.584 81.745 269.584 77.9417C269.584 74.1384 269.063 70.4184 268.021 66.761ZM246.879 84.4906C246.061 86.6111 244.847 88.3668 243.248 89.7475C241.648 91.1281 239.575 91.8211 237.037 91.8211C234.5 91.8211 232.52 91.1281 230.879 89.7475C229.238 88.3668 228.019 86.6111 227.196 84.4906C226.378 82.3649 225.961 80.182 225.961 77.9417C225.961 75.7014 226.378 73.5288 227.196 71.4083C228.019 69.2827 229.238 67.5269 230.879 66.1463C232.52 64.7656 234.578 64.0779 237.037 64.0779C239.496 64.0779 241.648 64.7656 243.248 66.1463C244.847 67.5269 246.061 69.2827 246.879 71.4083C247.702 73.5288 248.119 75.717 248.119 77.9417C248.119 80.1663 247.702 82.3649 246.879 84.4906Z"
                fill="white"
              />
              <path
                d="M199.366 78.5152C199.366 71.8724 198.126 66.2248 195.666 61.5619C193.207 56.9042 189.784 53.3509 185.382 50.8866C180.985 48.4275 175.868 47.1927 170.059 47.1927C164.683 47.1927 160.051 48.0784 156.128 49.8238C152.21 51.5796 148.995 53.924 146.458 56.8625C143.921 59.8218 142.03 63.1145 140.81 66.7719C139.586 70.4189 138.961 74.1127 138.961 77.8379C138.961 81.563 139.597 85.507 140.857 89.1904C142.134 92.8843 144.077 96.2083 146.677 99.1467C149.282 102.09 152.59 104.419 156.571 106.139C160.572 107.858 165.282 108.702 170.726 108.702C175.801 108.702 180.031 107.998 183.418 106.581C186.815 105.164 189.55 103.419 191.644 101.324C192.051 100.918 192.426 100.517 192.801 100.111L179.562 87.8098C178.666 89.5291 177.588 90.7899 176.322 91.6496C175.045 92.5092 173.185 92.9364 170.726 92.9364C167.522 92.9364 165.037 91.9726 163.292 90.0345C161.536 88.0963 160.546 85.856 160.322 83.3188H199.366V78.5152ZM160.218 71.5755C160.442 68.4495 161.458 66.131 163.292 64.6358C165.115 63.1509 167.22 62.4111 169.606 62.4111C172.44 62.4111 174.722 63.1666 176.426 64.7035C178.145 66.2248 179.041 68.5172 179.119 71.5755H160.218Z"
                fill="white"
              />
              <path
                d="M136.157 78.5152C136.157 71.8724 134.922 66.2248 132.463 61.5619C130.004 56.9042 126.575 53.3509 122.178 50.8866C117.776 48.4275 112.659 47.1927 106.856 47.1927C101.479 47.1927 96.842 48.0784 92.9241 49.8238C89.0062 51.5796 85.7916 53.924 83.2543 56.8625C80.7119 59.8218 78.8258 63.1145 77.6015 66.7719C76.3772 70.4189 75.752 74.1127 75.752 77.8379C75.752 81.563 76.3928 85.507 77.6536 89.1904C78.93 92.8843 80.8682 96.2083 83.4732 99.1467C86.0781 102.09 89.3865 104.419 93.3669 106.139C97.363 107.858 102.078 108.702 107.517 108.702C112.597 108.702 116.827 107.998 120.209 106.581C123.611 105.164 126.341 103.419 128.441 101.324C128.842 100.918 129.222 100.517 129.597 100.111L116.359 87.8098C115.457 89.5291 114.379 90.7899 113.118 91.6496C111.842 92.5092 109.976 92.9364 107.517 92.9364C104.318 92.9364 101.828 91.9726 100.083 90.0345C98.3268 88.0963 97.3369 85.856 97.1181 83.3188H136.157V78.5152ZM97.0139 71.5755C97.2327 68.4495 98.2487 66.131 100.083 64.6358C101.906 63.1509 104.016 62.4111 106.397 62.4111C109.237 62.4111 111.513 63.1666 113.222 64.7035C114.941 66.2248 115.838 68.5172 115.916 71.5755H97.0139Z"
                fill="white"
              />
              <path
                d="M71.3916 66.761C70.3496 63.114 68.7605 59.8057 66.6401 56.8621C64.5196 53.9236 61.8625 51.5635 58.7 49.8234C55.5376 48.0624 51.7864 47.1923 47.4673 47.1923C44.5497 47.1923 42.0489 47.5831 39.9649 48.3646C37.8809 49.1461 36.1773 50.0161 34.8748 50.9904C33.5723 51.9543 32.2854 53.2307 31.0246 54.7937H30.1233V22.5856L8.87695 45.447V107.586H30.1233V101.1H31.0246C32.2854 102.663 33.5723 103.924 34.8748 104.903C36.1773 105.867 37.8809 106.753 39.9649 107.534C42.0489 108.311 44.5497 108.701 47.4673 108.701C51.7864 108.701 55.5376 107.831 58.7 106.076C61.8625 104.33 64.5196 101.975 66.6401 99.0317C68.7605 96.0881 70.3496 92.7797 71.3916 89.1223C72.4336 85.4805 72.9546 81.745 72.9546 77.9417C72.9546 74.1384 72.4336 70.4184 71.3916 66.761ZM50.2494 84.4906C49.4315 86.6111 48.2176 88.3668 46.6181 89.7475C45.0186 91.1281 42.945 91.8211 40.4078 91.8211C37.8705 91.8211 35.9064 91.1281 34.2652 89.7475C32.6241 88.3668 31.3893 86.6111 30.5661 84.4906C29.7482 82.3649 29.3418 80.182 29.3418 77.9417C29.3418 75.7014 29.7482 73.5288 30.5661 71.4083C31.3893 69.2827 32.6241 67.5269 34.2652 66.1463C35.9064 64.7656 37.9487 64.0779 40.4078 64.0779C42.8669 64.0779 45.0186 64.7656 46.6181 66.1463C48.2176 67.5269 49.4315 69.2827 50.2494 71.4083C51.0726 73.5288 51.4894 75.717 51.4894 77.9417C51.4894 80.1663 51.0726 82.3649 50.2494 84.4906Z"
                fill="white"
              />
            </g>
            <defs>
              <clipPath id="clip0_1170_38">
                <rect width="460" height="130.734" fill="white" />
              </clipPath>
            </defs>
          </svg>
        </Link>

        {/* Desktop Navigation */}
        <nav className="hidden md:flex space-x-8 text-sm">
          {navLinks.map((link) =>
            link.scrollTo ? (
              <button
                key={link.label}
                onClick={() => scrollToSection(link.scrollTo!)}
                className="text-white hover:text-gray-300 transition-colors cursor-pointer"
              >
                {link.label}
              </button>
            ) : (
              <Link
                key={link.label}
                to={link.href}
                className="text-white hover:text-gray-300 transition-colors"
              >
                {link.label}
              </Link>
            )
          )}
        </nav>

        {/* Header CTA (desktop) */}
        <a
          href="https://docs.google.com/forms/d/e/1FAIpQLSd4h0aDIi5hdXQzFDwWiNagrhRvYzgalKylhy7bhsVGIREvgg/viewform?usp=publish-editor"
          target="_blank"
          className="hidden md:inline-block bg-orange-500 text-white px-6 py-2 rounded-full hover:bg-orange-600 transition-colors cursor-pointer"
        >
          Get a Quote
        </a>

        {/* Hamburger Button (mobile) */}
        <button
          className="flex flex-col justify-center items-center w-10 h-10 md:hidden z-[100000] relative"
          aria-label="Open menu"
          onClick={handleMenuToggle}
        >
          <div
            ref={topBar}
            className="w-8 h-[2px] bg-white rounded transition-all"
            style={{ marginBottom: 5 }}
          />
          <div
            ref={midBar}
            className="w-8 h-[2px] bg-white rounded transition-all"
            style={{ marginBottom: 5 }}
          />
          <div
            ref={botBar}
            className="w-8 h-[2px] bg-white rounded transition-all"
          />
        </button>

        {/* Mobile Menu Overlay */}
        <div
          ref={menuRef}
          className="fixed top-0 right-0 w-full h-screen bg-[#181818] bg-opacity-95 flex flex-col items-center justify-center gap-10 z-[99998] md:hidden"
          style={{
            pointerEvents: "none",
            opacity: 0,
            transform: "translateX(100%)",
          }}
        >
          <nav className="flex flex-col items-center gap-8 text-lg">
            {navLinks.map((link) =>
              link.scrollTo ? (
                <button
                  key={link.label}
                  onClick={() => scrollToSection(link.scrollTo!)}
                  className="text-white uppercase hover:text-orange-400 transition-colors text-2xl cursor-pointer"
                >
                  {link.label}
                </button>
              ) : (
                <a
                  key={link.label}
                  href={link.href}
                  className="text-white uppercase hover:text-orange-400 transition-colors text-2xl"
                  onClick={() => setMenuOpen(false)}
                >
                  {link.label}
                </a>
              )
            )}
          </nav>
          <a
            href="https://docs.google.com/forms/d/e/1FAIpQLSd4h0aDIi5hdXQzFDwWiNagrhRvYzgalKylhy7bhsVGIREvgg/viewform?usp=publish-editor"
            target="_blank"
            className="bg-orange-500 text-white px-8 py-3 rounded-full hover:bg-orange-600 transition-colors cursor-pointer text-lg mt-8"
          >
            Get a Quote
          </a>
        </div>
      </header>
    </div>
  );
}
